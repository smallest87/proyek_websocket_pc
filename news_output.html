<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu Konten Dinamis (Display)</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font dasar untuk tampilan yang lebih modern */
        body {
            font-family: 'Inter', sans-serif;
            background-color: transparent; 
            min-height: 100vh;
        }

        /* Container untuk semua kartu */
        #cards-container {
            position: relative;
        }

        /* Style dasar untuk setiap kartu: Posisi dan Ukuran Tengah */
        .animated-card-item {
            position: fixed;
            top: 50%;   /* Titik jangkar tengah vertikal */
            left: 0;    /* Titik jangkar kiri penuh */
            right: 0;   /* Titik jangkar kanan penuh (memungkinkan margin) */
            max-width: 600px; 
            z-index: 10; 
            margin: 24px auto !important;

            opacity: 0;
            
            /* Posisi tengah vertikal, horizontal akan disetel oleh margin auto saat is-visible */
            transform: translateY(-50%); 
        }

        /* Transisi hanya ditambahkan setelah posisi awal (untuk mencegah 'jump') */
        .has-transition {
            transition: transform 333ms ease-out, opacity 333ms ease-out;
        }
        
        /* ------------------------------------------- */
        /* KONDISI TERSEMBUNYI (CSS FLY OUT DYNAMIC)  */
        /* ------------------------------------------- */
        
        /* Default: Fly Out Kiri */
        .animated-card-item[data-fly-direction="left"] {
            transform: translateX(calc(-100% - 10px)) translateY(-50%); 
        }

        /* Fly Out Kanan */
        .animated-card-item[data-fly-direction="right"] {
            transform: translateX(calc(100vw + 10px)) translateY(-50%); 
        }

        /* Fly Out Atas (Menggunakan posisi Y) */
        .animated-card-item[data-fly-direction="top"] {
            transform: translateY(calc(-100% - 50vh)); 
        }

        /* Fly Out Bawah (Menggunakan posisi Y) */
        .animated-card-item[data-fly-direction="bottom"] {
            transform: translateY(calc(50vh + 100%)); 
        }

        /* ------------------------------------------- */
        /* KONDISI TERLIHAT (CSS FLY IN)              */
        /* ------------------------------------------- */
        .is-visible {
            opacity: 1 !important; 
            
            /* Penempatan Akhir (Tengah Layar dengan Margin 24px) */
            margin: 24px auto !important; /* Margin Top/Bottom 24px, Horizontal Auto untuk Centering */
            
            /* MENGATUR POSISI TENGAH */
            transform: translateY(-50%) translateX(0) !important; 
        }
    </style>
</head>
<body>

    <!-- Container Utama untuk Menampung Semua Kartu Berita -->
    <div id="cards-container">
        <!-- Kartu-kartu akan dimasukkan di sini secara dinamis oleh JavaScript -->
    </div>

    <!-- Kode JavaScript untuk Memicu Animasi dan Menerima Data via WebSocket -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cardsContainer = document.getElementById('cards-container');
            
            // Map untuk menyimpan referensi elemen DOM kartu: { itemId: HTMLElement }
            let cardElementMap = {}; 
            let flyDirection = 'left'; // STATE Lokal untuk arah fly

            // PENGATURAN WEBSOCKET
            const port = 8080;
            // const ip = "192.168.0.100";
            const ip = "10.202.220.208";
            const wsUrl = `ws://${ip}:${port}`;

            let ws = null;

            // --- KARTU UTILITIES ---
            
            // Fungsi untuk membuat elemen kartu baru
            function createCardElement(item) {
                const card = document.createElement('div');
                card.id = `card-item-${item.id}`;
                
                // Gunakan flyDirection sebagai attribute untuk menargetkan CSS
                card.setAttribute('data-fly-direction', flyDirection); 
                
                card.className = 'animated-card-item bg-white shadow-xl rounded-xl overflow-hidden hover:shadow-2xl cursor-default';
                card.setAttribute('role', 'alert');
                card.setAttribute('aria-hidden', !item.isVisible);

                // --- HTML Structure for a single card ---
                card.innerHTML = `
                    <!-- 1. Thumbnail Ukuran Sedang -->
                    <div class="thumbnail-container">
                        <img 
                            id="thumbnail-img-${item.id}"
                            src="${item.thumbnail || 'https://placehold.co/600x338/4f46e5/ffffff?text=Default+Gambar'}" 
                            alt="Gambar Thumbnail" 
                            class="w-full h-auto object-cover rounded-t-xl"
                            onerror="this.onerror=null; this.src='https://placehold.co/600x338/1f2937/ffffff?text=Gagal+Memuat';"
                        >
                    </div>

                    <!-- Bagian Teks (Judul dan Caption) -->
                    <div class="p-4">
                        
                        <!-- 2. Label Judul -->
                        <h2 id="judul-teks-${item.id}" class="text-xl font-extrabold text-gray-900 mb-1 leading-tight">
                            ${item.judul}
                        </h2>

                        <!-- 3. Teks Caption -->
                        <p id="caption-teks-${item.id}" class="text-sm text-gray-600 ${item.showCaption ? '' : 'hidden'}">
                            ${item.caption}
                        </p>
                        
                    </div>

                    <!-- 4. Footer Kartu (Sumber) -->
                    <div id="sumber-teks-container-${item.id}" class="bg-black p-2 text-white text-xs font-medium text-right">
                        Sumber: ${item.sumber}
                    </div>
                `;
                
                // Set visibilitas awal (penting untuk animasi)
                if (item.isVisible) {
                    card.classList.add('is-visible');
                } else {
                    card.classList.remove('is-visible');
                }

                cardsContainer.appendChild(card);
                
                // --- FIX: Mencegah Jump Awal ---
                // Tambahkan transisi setelah kartu diletakkan di posisi awal
                requestAnimationFrame(() => {
                    card.classList.add('has-transition');
                });
                // --- AKHIR FIX ---

                return card;
            }

            // Fungsi untuk memperbarui konten kartu yang sudah ada
            function updateCardContent(itemId, data) {
                const card = cardElementMap[itemId];
                if (!card) return;

                const judulElement = document.getElementById(`judul-teks-${itemId}`);
                const captionElement = document.getElementById(`caption-teks-${itemId}`);
                const sumberContainer = document.getElementById(`sumber-teks-container-${itemId}`);
                const thumbnailImg = document.getElementById(`thumbnail-img-${itemId}`);
                
                if (data.judul) judulElement.textContent = data.judul;
                if (data.caption !== undefined) captionElement.textContent = data.caption;
                
                // Kontrol visibilitas caption
                if (data.showCaption !== undefined) {
                    captionElement.classList.toggle('hidden', !data.showCaption);
                }

                if (data.sumber !== undefined) {
                     sumberContainer.textContent = data.sumber ? `Sumber: ${data.sumber}` : "";
                }
                
                // Update Thumbnail Source
                if (data.thumbnail) {
                    thumbnailImg.src = data.thumbnail || "https://placehold.co/600x338/4f46e5/ffffff?text=Ganti+Gambar";
                }
                
                // Update visibilitas jika status dikirim bersama data
                if (data.isVisible !== undefined) {
                    toggleCardVisibility(itemId, data.isVisible);
                }
            }
            
            // Fungsi untuk mengelola Fly In/Out
            function toggleCardVisibility(itemId, forceVisible = undefined) {
                const card = cardElementMap[itemId];
                if (!card) return;

                const shouldBeVisible = forceVisible !== undefined ? forceVisible : !card.classList.contains('is-visible');
                
                // Atur arah Fly (penting jika flyDirection berubah saat kartu sudah ada)
                card.setAttribute('data-fly-direction', flyDirection);
                
                card.classList.toggle('is-visible', shouldBeVisible);
                card.setAttribute('aria-hidden', !shouldBeVisible);
            }

            // --- SINKRONISASI DAFTAR KARTU UTAMA ---
            function syncAllCards(allItemData, newFlyDirection) {
                const receivedIds = new Set(allItemData.map(item => item.id));
                const currentIds = new Set(Object.keys(cardElementMap));
                
                // Perbarui state arah fly global
                flyDirection = newFlyDirection || flyDirection; 

                // 1. Tambah atau Update Item
                allItemData.forEach(item => {
                    if (cardElementMap[item.id]) {
                        // Update Item yang sudah ada
                        // Perbarui data-fly-direction setiap update
                        cardElementMap[item.id].setAttribute('data-fly-direction', flyDirection); 
                        updateCardContent(item.id, item);
                    } else {
                        // Tambah Item baru (akan dibuat dengan flyDirection saat ini)
                        const newCard = createCardElement(item);
                        cardElementMap[item.id] = newCard;
                        console.log(`Card baru dibuat: ${item.id}`);
                    }
                });

                // 2. Hapus Item yang tidak ada lagi
                currentIds.forEach(id => {
                    if (!receivedIds.has(id)) {
                        const cardToRemove = cardElementMap[id];
                        if (cardToRemove) {
                            cardToRemove.remove();
                            delete cardElementMap[id];
                            console.log(`Card dihapus: ${id}`);
                        }
                    }
                });
            }

            // --- WEBSOCKET CONNECTION ---
            function connectWebSocket() {
                try {
                    ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        console.log('WebSocket Output Connected.');
                    };

                    ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            
                            if (message.command === 'TOGGLE_VISIBILITY') {
                                // Jika toggle visibility, kita hanya bisa mengandalkan data item yang sudah ada
                                toggleCardVisibility(message.itemId);
                            } else if (message.command === 'UPDATE_CONTENT_ALL' && message.payload) {
                                // Sinkronisasi seluruh daftar kartu, termasuk arah fly global
                                syncAllCards(message.payload, message.flyDirection);
                            }
                        } catch (e) {
                            console.error('Error parsing WS message:', e);
                        }
                    };

                    ws.onclose = (event) => {
                        console.log('WebSocket Output Disconnected:', event.reason);
                        setTimeout(connectWebSocket, 5000); // Reconnect attempt
                    };

                    ws.onerror = (error) => {
                        console.error('WebSocket Output Error:', error);
                    };

                } catch (e) {
                    console.error("Error creating WebSocket:", e);
                }
            }

            // Inisialisasi koneksi
            connectWebSocket();
        });
    </script>

</body>
</html>